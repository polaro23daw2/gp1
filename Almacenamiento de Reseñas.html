<!DOCTYPE html>
<html lang="es">
<head>
  <title>Almacenamiento de Reseñas con Calificación</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      text-align: center;
    }

    label {
      display: block;
      margin-bottom: 5px;
    }

    textarea {
      width: 100%;
      margin-bottom: 10px;
    }

    select {
      width: 100%;
      margin-bottom: 15px;
    }

    button {
      padding: 10px;
      margin-right: 10px;
    }

    .reseña {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px;
      width: 300px; /* Ajusta el ancho según tus preferencias */
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>Deja tu Reseña</h1>
  <label for="reseñaNombre">Nombre:</label>
  <textarea id="reseñaNombre" rows="1" placeholder="Escribe tu nombre"></textarea>
  <label for="reseñaTexto">Reseña:</label>
  <textarea id="reseñaTexto" rows="4" placeholder="Escribe tu reseña aquí"></textarea>
  <label for="calificacion">Calificación:</label>
  <select id="calificacion" name="calificacion">
    <option value="1">1 estrella</option>
    <option value="1.5">1.5 estrellas</option>
    <option value="2">2 estrellas</option>
    <option value="2.5">2.5 estrellas</option>
    <option value="3">3 estrellas</option>
    <option value="3.5">3.5 estrellas</option>
    <option value="4">4 estrellas</option>
    <option value="4.5">4.5 estrellas</option>
    <option value="5">5 estrellas</option>
  </select>
  <br>
  <button id="guardarReseñaBtn">Guardar Reseña</button>
  <button id="limpiarReseñasBtn">Limpiar Reseñas</button>
  <button id="buscarReseñaBtn">Buscar Reseña</button>
  <div id="historialReseñas"></div>

  <script>
    class AlmacenReseñas {
  constructor() {
      this.taula = document.getElementById('historialReseñas');
      this.dbName = 'ReseñasDB';
      this.dbVersion = 1;
      this.objectStoreName = 'reseñas';
      this.db = null;
      this.init();
  }

  init() {
      const request = indexedDB.open(this.dbName, this.dbVersion);

      request.onerror = (event) => {
          console.error("Error al abrir la base de datos:", event.target.errorCode);
      };

      request.onupgradeneeded = (event) => {
          const db = event.target.result;
          const objectStore = db.createObjectStore(this.objectStoreName, { keyPath: 'id', autoIncrement: true });
          objectStore.createIndex('nombre', 'nombre', { unique: false });
          objectStore.createIndex('calificacion', 'calificacion', { unique: false });
          objectStore.createIndex('fecha', 'fecha', { unique: false });
      };

      request.onsuccess = (event) => {
          this.db = event.target.result;
          this.mostrarReseñas();
      };
  }

  guardarReseña() {
      const nombreUsuario = document.getElementById('reseñaNombre').value;
      const nuevaReseña = document.getElementById('reseñaTexto').value;
      const calificacion = document.getElementById('calificacion').value;
      const fecha = new Date().toLocaleString();

      const transaction = this.db.transaction([this.objectStoreName], 'readwrite');
      const objectStore = transaction.objectStore(this.objectStoreName);
      const reseña = { nombre: nombreUsuario, texto: nuevaReseña, calificacion: calificacion, fecha: fecha };

      const request = objectStore.add(reseña);

      request.onsuccess = () => {
          console.log('Reseña añadida con éxito');
          this.mostrarReseñas();
      };

      request.onerror = (event) => {
          console.error('Error al añadir la reseña:', event.target.errorCode);
      };
  }

  limpiarReseñas() {
      const transaction = this.db.transaction([this.objectStoreName], 'readwrite');
      const objectStore = transaction.objectStore(this.objectStoreName);
      const request = objectStore.clear();

      request.onsuccess = () => {
          console.log('Reseñas eliminadas con éxito');
          this.mostrarReseñas();
      };

      request.onerror = (event) => {
          console.error('Error al eliminar las reseñas:', event.target.errorCode);
      };
  }

  buscarReseña() {
      const nombreBusqueda = document.getElementById('reseñaNombre').value;
      const transaction = this.db.transaction([this.objectStoreName], 'readonly');
      const objectStore = transaction.objectStore(this.objectStoreName);
      const index = objectStore.index('nombre');
      const request = index.getAll(nombreBusqueda);

      request.onsuccess = () => {
          const reseñasFiltradas = request.result;
          this.mostrarReseñas(reseñasFiltradas);
      };

      request.onerror = (event) => {
          console.error('Error al buscar la reseña:', event.target.errorCode);
      };
  }

  mostrarReseñas(reseñas = null) {
      this.taula.innerHTML = '';

      const transaction = this.db.transaction([this.objectStoreName], 'readonly');
      const objectStore = transaction.objectStore(this.objectStoreName);
      const request = objectStore.getAll();

      request.onsuccess = () => {
          const reseñasMostrar = reseñas || request.result;

          reseñasMostrar.forEach((reseña, index) => {
              const div = document.createElement('div');
              div.className = 'reseña';
              div.innerHTML = `<strong>${reseña.nombre}</strong><br>Estrellas: ${reseña.calificacion}<br>${reseña.texto}`;
              this.taula.appendChild(div);
          });
      };

      request.onerror = (event) => {
          console.error('Error al mostrar las reseñas:', event.target.errorCode);
      };
  }
}

// Crear una instancia de la clase
const almacenReseñas = new AlmacenReseñas();

// Event Listeners
document.getElementById('guardarReseñaBtn').addEventListener('click', () => {
  almacenReseñas.guardarReseña();
});

document.getElementById('limpiarReseñasBtn').addEventListener('click', () => {
  almacenReseñas.limpiarReseñas();
});

document.getElementById('buscarReseñaBtn').addEventListener('click', () => {
  almacenReseñas.buscarReseña();
});
  </script>
</body>
</html>
